{% extends "layout.html" %}
{% block title %}Face Detect{% endblock %}
{% block header_title %}Face Detection & Identification{% endblock %}
{% block content %}
<div x-data="faceDetectApp()" class="max-w-5xl mx-auto space-y-6" x-init="init()">
    <div class="glass-panel rounded-2xl p-6 shadow-soft border border-base-200">
        <h2 class="text-2xl font-bold flex items-center gap-2 text-primary mb-4">
            <i data-lucide="scan-face" class="w-6 h-6"></i>
            <span>Upload Image</span>
        </h2>
        <div class="flex flex-col md:flex-row gap-6">
            <div class="flex-1">
                <div class="border-2 border-dashed rounded-xl p-6 h-64 flex flex-col items-center justify-center gap-4 relative"
                    :class="isDragging ? 'bg-primary/5 border-primary' : 'border-base-300'"
                    @dragover.prevent="isDragging=true" @dragleave="isDragging=false"
                    @drop.prevent="handleDrop($event)">
                    <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer"
                        @change="handleFile($event)" />
                    <template x-if="!preview">
                        <div class="text-center pointer-events-none">
                            <div
                                class="w-14 h-14 bg-base-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="image-plus" class="w-7 h-7 text-base-content/50"></i>
                            </div>
                            <p class="font-medium">Drag & Drop or Click</p>
                            <p class="text-xs opacity-60 mt-1">PNG / JPG up to 5MB</p>
                        </div>
                    </template>
                    <template x-if="preview">
                        <div class="relative w-full h-full">
                            <img :src="preview" class="object-contain w-full h-full" />
                            <button type="button" @click="removeImage"
                                class="btn btn-xs btn-circle btn-error absolute top-2 right-2">âœ•</button>
                        </div>
                    </template>
                </div>
                <button class="btn btn-primary w-full mt-4" @click="identify" :disabled="!file || isLoading">
                    <span x-show="isLoading" class="loading loading-spinner"></span>
                    <span x-text="isLoading ? 'Detecting...' : 'Detect Faces'">Detect Faces</span>
                </button>
            </div>
            <div class="flex-1">
                <div class="p-4 bg-base-200/50 rounded-xl border border-base-300 h-64 overflow-auto text-sm font-mono"
                    id="log-box">
                    <template x-for="l in logs" :key="l.id">
                        <div :class="l.type==='error'?'text-error':'text-primary'" x-text="l.msg"></div>
                    </template>
                    <div x-show="isLoading" class="animate-pulse">Processing image...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-panel rounded-2xl p-6 shadow-soft border border-base-200" x-show="faces.length > 0">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
            <i data-lucide="users" class="w-5 h-5 text-primary"></i>
            <span>Detected Faces</span>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <template x-for="f in faces" :key="f.bbox.join('-')">
                <div class="card bg-base-100 shadow border border-base-200">
                    <div class="card-body p-4 space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="badge" :class="f.matched ? 'badge-success text-white' : 'badge-outline'"
                                x-text="f.matched ? 'Matched' : 'Unknown'"></span>
                            <span class="text-xs opacity-60"
                                x-text="'Similarity: ' + (f.similarity ? f.similarity.toFixed(3) : '0.000')"></span>
                        </div>
                        <div class="text-xs font-mono" x-text="'BBox: ['+f.bbox.join(', ')+']'"></div>
                        <template x-if="f.student">
                            <div class="space-y-1 text-sm">
                                <div class="font-bold" x-text="f.student.name"></div>
                                <div class="flex flex-wrap gap-2 text-xs">
                                    <span class="badge badge-outline" x-text="f.student.student_code"></span>
                                    <span class="badge badge-outline" x-text="f.student.class_name"></span>
                                    <span class="badge badge-outline" x-text="f.student.status"></span>
                                </div>
                                <div class="text-xs opacity-70" x-text="f.student.email"></div>
                            </div>
                        </template>
                        <template x-if="!f.student">
                            <div class="text-xs opacity-50">No student match above threshold.</div>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
    function faceDetectApp() {
        return {
            file: null, preview: null, faces: [], logs: [], isDragging: false, isLoading: false,
            init() { this.log('Ready. Upload an image.'); },
            handleFile(e) { const f = e.target.files[0]; if (f) this.setFile(f); },
            handleDrop(e) { this.isDragging = false; const f = e.dataTransfer.files[0]; if (f) this.setFile(f); },
            setFile(f) { this.file = f; this.preview = URL.createObjectURL(f); this.faces = []; },
            removeImage() { this.file = null; this.preview = null; this.faces = []; },
            log(msg, type = 'info') { this.logs.push({ id: Date.now() + Math.random(), msg, type }); this.$nextTick(() => { const b = document.getElementById('log-box'); b.scrollTop = b.scrollHeight; }); },
            async identify() {
                if (!this.file) return;
                this.isLoading = true; this.log('Sending image to server...');
                const form = new FormData(); form.append('file', this.file);
                try {
                    const res = await fetch('/api/students/face/recognize', { method: 'POST', body: form });
                    const data = await res.json();
                    if (data.result === 'success') {
                        this.faces = data.reply.faces || []; this.log(`Detected ${this.faces.length} face(s).`);
                        if (data.reply.message && data.reply.message !== 'ok') this.log(data.reply.message, 'error');
                    } else { this.log(data.message || 'Error', 'error'); }
                } catch (e) { this.log(e.message, 'error'); }
                finally { this.isLoading = false; }
            }
        }
    }
</script>
{% endblock %}