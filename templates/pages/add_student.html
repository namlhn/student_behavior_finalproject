{% extends "layout.html" %}

{% block title %}Add New Student{% endblock %}
{% block header_title %}Add New Student{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto" x-data="addStudentController()">
    <div class="mb-6">
        <a href="/students" class="btn btn-ghost gap-2 hover:bg-base-200/50 transition-colors">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to List
        </a>
    </div>

    <div class="glass-panel rounded-3xl shadow-soft p-0 overflow-hidden">
        <div class="bg-base-100/50 p-8 border-b border-base-200 backdrop-blur-md">
            <h2 class="text-2xl font-bold flex items-center gap-3 text-primary">
                <div class="p-3 bg-primary/10 rounded-xl">
                    <i data-lucide="user-plus" class="w-6 h-6"></i>
                </div>
                Create New Student Profile
            </h2>
            <p class="text-base-content/60 mt-2 ml-14">Enter the student's personal and academic details below.</p>
        </div>

        <div class="p-8">
            <form @submit.prevent="submitForm">
                <!-- Two Column Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <!-- Column 1: Personal + Core Academic IDs -->
                    <div class="space-y-6">
                        <div
                            class="flex items-center gap-2 text-primary font-bold uppercase tracking-wider text-xs border-b border-base-200 pb-2">
                            <i data-lucide="user" class="w-4 h-4"></i> Thông tin cá nhân
                        </div>

                        <div class="form-control w-full">
                            <label class="label font-medium"><span class="label-text">Họ và Tên <span
                                        class="text-error">*</span></span></label>
                            <input type="text" x-model="formData.name"
                                class="input input-bordered w-full focus:input-primary bg-base-100/50" required
                                placeholder="Ví dụ: Nguyễn Văn A" />
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label font-medium"><span class="label-text">Ngày sinh</span></label>
                                <input type="date" x-model="formData.date_of_birth"
                                    class="input input-bordered w-full focus:input-primary bg-base-100/50" />
                            </div>
                            <div class="form-control">
                                <label class="label font-medium"><span class="label-text">Giới tính</span></label>
                                <select x-model="formData.gender"
                                    class="select select-bordered w-full focus:select-primary bg-base-100/50">
                                    <option value="Male">Nam</option>
                                    <option value="Female">Nữ</option>
                                    <option value="Other">Khác</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-control">
                            <label class="label font-medium"><span class="label-text">Email <span
                                        class="text-error">*</span></span></label>
                            <input type="email" x-model="formData.email"
                                class="input input-bordered w-full focus:input-primary bg-base-100/50" required
                                placeholder="student@domain.com" />
                        </div>

                        <div class="form-control">
                            <label class="label font-medium"><span class="label-text">Số điện thoại</span></label>
                            <input type="tel" x-model="formData.phone"
                                class="input input-bordered w-full focus:input-primary bg-base-100/50"
                                placeholder="+84..." />
                        </div>

                        <div class="form-control">
                            <label class="label font-medium"><span class="label-text">Mã Sinh viên</span></label>
                            <input type="text" x-model="formData.student_code"
                                class="input input-bordered w-full focus:input-primary bg-base-100/50 font-mono"
                                placeholder="Tự sinh nếu để trống" />
                        </div>

                        <div class="form-control">
                            <label class="label font-medium"><span class="label-text">Lớp</span></label>
                            <input type="text" x-model="formData.class_name"
                                class="input input-bordered w-full focus:input-primary bg-base-100/50"
                                placeholder="VD: CS-2024A" />
                        </div>

                        <div class="form-control">
                            <label class="label font-medium"><span class="label-text">Địa chỉ</span></label>
                            <textarea x-model="formData.address"
                                class="textarea textarea-bordered h-32 focus:textarea-primary bg-base-100/50 resize-none"
                                placeholder="Nhập địa chỉ..."></textarea>
                        </div>
                    </div>

                    <!-- Column 2: Academic Details -->
                    <div class="space-y-6">
                        <div
                            class="flex items-center gap-2 text-secondary-content font-bold uppercase tracking-wider text-xs border-b border-base-200 pb-2">
                            <i data-lucide="graduation-cap" class="w-4 h-4"></i> Thông tin học tập
                        </div>

                        <div class="form-control">
                            <label class="label font-medium"><span class="label-text">Chuyên ngành</span></label>
                            <input type="text" x-model="formData.major"
                                class="input input-bordered w-full focus:input-primary bg-base-100/50"
                                placeholder="VD: Khoa học máy tính" />
                        </div>

                        <div class="form-control">
                            <label class="label font-medium"><span class="label-text">Khóa / Khóa học</span></label>
                            <input type="text" x-model="formData.course"
                                class="input input-bordered w-full focus:input-primary bg-base-100/50"
                                placeholder="VD: K15" />
                        </div>

                        <div class="p-6 bg-base-200/50 rounded-2xl border border-base-200">
                            <div class="space-y-6">
                                <div class="form-control">
                                    <label class="label font-medium"><span class="label-text">Bậc học</span></label>
                                    <select x-model="formData.academic_level"
                                        class="select select-bordered w-full focus:select-primary bg-white">
                                        <option value="Freshman">Năm 1</option>
                                        <option value="Sophomore">Năm 2</option>
                                        <option value="Junior">Năm 3</option>
                                        <option value="Senior">Năm 4</option>
                                    </select>
                                </div>
                                <div class="form-control">
                                    <label class="label font-medium"><span class="label-text">GPA</span></label>
                                    <input type="number" step="0.01" min="0" max="4" x-model="formData.gpa"
                                        class="input input-bordered w-full focus:input-primary bg-white"
                                        placeholder="0.00" />
                                </div>
                                <div class="form-control">
                                    <label class="label font-medium"><span class="label-text">Trạng thái</span></label>
                                    <select x-model="formData.status"
                                        class="select select-bordered w-full focus:select-primary bg-white">
                                        <option value="Active">Đang học</option>
                                        <option value="Inactive">Tạm dừng</option>
                                        <option value="Graduated">Tốt nghiệp</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-action border-t border-base-200 mt-10 pt-6 flex justify-end gap-3">
                    <a href="/students" class="btn btn-ghost hover:bg-base-200">Cancel</a>
                    <button type="submit"
                        class="btn btn-primary px-8 gap-2 shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all"
                        :class="isLoading ? 'btn-disabled' : ''">
                        <span x-show="isLoading" class="loading loading-spinner loading-sm"></span>
                        <i data-lucide="save" class="w-4 h-4" x-show="!isLoading"></i>
                        Create Student
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function addStudentController() {
        return {
            isLoading: false,
            formData: {
                name: '', email: '', student_code: '', date_of_birth: null, gender: 'Male',
                phone: '', address: '', class_name: '', major: '', course: '',
                academic_level: 'Freshman', gpa: null, status: 'Active'
            },

            async submitForm() {
                this.isLoading = true;

                // Clean data before sending
                const payload = { ...this.formData };
                if (!payload.date_of_birth) payload.date_of_birth = null;
                if (payload.gpa === '' || payload.gpa === null) payload.gpa = null;
                else payload.gpa = parseFloat(payload.gpa);

                try {
                    const response = await fetch('/api/students/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.detail || 'Operation failed');
                    }

                    // Success with SweetAlert2
                    await Swal.fire({
                        title: 'Success!',
                        text: 'Student created successfully!',
                        icon: 'success',
                        confirmButtonColor: '#01923F',
                        timer: 2000,
                        timerProgressBar: true
                    });

                    // Redirect with cache-busting query so list definitely refetches
                    window.location.href = '/students?ts=' + Date.now();

                } catch (error) {
                    Swal.fire({
                        title: 'Error!',
                        text: error.message,
                        icon: 'error',
                        confirmButtonColor: '#EF4444'
                    });
                } finally {
                    this.isLoading = false;
                }
            }
        }
    }
</script>
{% endblock %}